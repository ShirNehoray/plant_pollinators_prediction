library(dplyr)
library(tidyr)
library(purrr)
library(vegan)
library(ggplot2)
library(tibble)  # ← חשוב! בשביל rownames_to_column

# 1. יצירת מטריצת נוכחות
interactions_binary <- data_filtered %>%
  select(Study_id, Network_id, Plant_accepted_name, Pollinator_accepted_name) %>%
  distinct() %>%
  unite("interaction", Plant_accepted_name, Pollinator_accepted_name, sep = "_") %>%
  mutate(Network_id = as.character(Network_id)) %>%  # ← חשוב: הכל ל-character
  mutate(presence = 1) %>%
  pivot_wider(
    names_from = Network_id,
    values_from = presence,
    values_fill = 0
  )

# 2. חישוב Jaccard בין כל זוג רשתות – **בלי as.numeric!**
jaccard_results <- interactions_binary %>%
  group_by(Study_id) %>%
  nest() %>%
  mutate(
    jaccard_pairs = map(data, ~ {
      mat <- .x %>%
        select(-interaction) %>%
        as.matrix() %>%
        t()  # שורות = רשתות
      
      net_names <- rownames(mat)
      
      if (length(net_names) < 2) {
        return(tibble(Network1 = character(), Network2 = character(), Jaccard = numeric()))
      }
      
      dist_mat <- vegdist(mat, method = "jaccard")  # Jaccard distance
      
      as.data.frame(as.matrix(dist_mat)) %>%
        rownames_to_column("Network1") %>%
        pivot_longer(
          cols = -Network1,
          names_to = "Network2",
          values_to = "Jaccard"
        ) %>%
        filter(Network1 < Network2) %>%  # רק זוגות ייחודיים
        mutate(
          Network1 = factor(Network1, levels = net_names),
          Network2 = factor(Network2, levels = net_names)
        )
    })
  ) %>%
  select(Study_id, jaccard_pairs) %>%
  unnest(jaccard_pairs)
