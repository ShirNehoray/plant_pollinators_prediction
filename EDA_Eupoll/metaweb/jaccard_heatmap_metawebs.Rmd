---
title: "jaccard between bioregions metawebs"
output: html_document
date: "2025-10-29"
---
```{r}
setwd("/Users/shirnehoray/EDA")

# --- Load required packages ---
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)  # for Bray–Curtis

# --- Step 1: Read the dataset ---
data <- read.csv("Interaction_data.csv")

# --- Step 2: Define bioregions and initialize a list ---
bioregions <- c("Alpine", "Atlantic", "Boreal", "Continental")
metaweb_list <- list()

# --- Step 3: Loop through each bioregion to create metawebs ---
for (bio in bioregions) {
  # Filter rows for this bioregion
  df_bio <- data %>%
    filter(Bioregion == bio) %>%
    select(Plant_accepted_name, Pollinator_accepted_name, Interaction)
  
  # Sum interactions for each unique plant-pollinator pair
  df_sum <- df_bio %>%
    group_by(Plant_accepted_name, Pollinator_accepted_name) %>%
    summarise(total_interactions = sum(Interaction, na.rm = TRUE), .groups = 'drop')
  
  # Create an interaction matrix
  meta_matrix <- df_sum %>%
    pivot_wider(names_from = Pollinator_accepted_name,
                values_from = total_interactions,
                values_fill = 0)
  
  # Turn the matrix into a data frame
  meta_df <- as.data.frame(meta_matrix)
  
  # Store both versions in the list
  metaweb_list[[bio]] <- list(
    matrix = meta_matrix,
    dataframe = meta_df
  )
}

# --- Step 4: Prepare a list of unique interaction pairs for each bioregion ---
interaction_sets <- list()

for (bio in names(metaweb_list)) {
  df <- metaweb_list[[bio]]$dataframe
  
  # Convert matrix back to a long format to get pairs
  df_long <- df %>%
    pivot_longer(-Plant_accepted_name, names_to = "Pollinator_accepted_name", values_to = "value") %>%
    filter(value > 0) %>%
    mutate(pair = paste(Plant_accepted_name, Pollinator_accepted_name, sep = "_"))
  
  interaction_sets[[bio]] <- unique(df_long$pair)
}

# --- Step 5: Calculate pairwise Jaccard similarities (binary) ---
bioregion_names <- names(interaction_sets)
n <- length(bioregion_names)
jaccard_matrix <- matrix(NA, nrow = n, ncol = n,
                         dimnames = list(bioregion_names, bioregion_names))

for (i in 1:n) {
  for (j in 1:n) {
    set_i <- interaction_sets[[i]]
    set_j <- interaction_sets[[j]]
    
    inter <- length(intersect(set_i, set_j))
    union_val <- length(union(set_i, set_j))
    
    if (union_val == 0) {
      jaccard_matrix[i, j] <- 0
    } else {
      jaccard_matrix[i, j] <- inter / union_val
    }
  }
}

# --- Step 6: Convert Jaccard matrix for plotting ---
jaccard_df <- as.data.frame(jaccard_matrix) %>%
  mutate(Bioregion1 = rownames(.)) %>%
  pivot_longer(-Bioregion1, names_to = "Bioregion2", values_to = "Jaccard")

# --- Step 7: Plot Jaccard heatmap ---
ggplot(jaccard_df, aes(x = Bioregion1, y = Bioregion2, fill = Jaccard)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(Jaccard, 2)), color = "red", size = 4) +
  scale_fill_viridis_c(option = "viridis", name = "Jaccard\nSimilarity", limits = c(0, 1)) +
  theme_minimal() +
  labs(title = "Jaccard Similarity of Plant-Pollinator Metawebs",
       x = "Bioregion", y = "Bioregion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))

# --- Step 8: Calculate pairwise Bray–Curtis similarities (quantitative) ---
# Create a combined matrix where rows = bioregions, columns = unique interactions
interaction_union <- unique(unlist(interaction_sets))
# Clean column names to ensure valid matrix names
interaction_union <- make.names(interaction_union, unique = TRUE)

quant_matrix <- matrix(0, nrow = n, ncol = length(interaction_union),
                       dimnames = list(bioregion_names, interaction_union))

# Fill with total interaction counts safely
for (bio in bioregion_names) {
  df <- metaweb_list[[bio]]$dataframe
  df_long <- df %>%
    pivot_longer(-Plant_accepted_name, names_to = "Pollinator_accepted_name", values_to = "value") %>%
    mutate(pair = paste(Plant_accepted_name, Pollinator_accepted_name, sep = "_"))
  
  # Clean pair names the same way
  df_long$pair <- make.names(df_long$pair, unique = TRUE)
  
  pair_sum <- df_long %>%
    group_by(pair) %>%
    summarise(total = sum(value), .groups = "drop")
  
  # Match only pairs that exist in the matrix
  valid_pairs <- intersect(pair_sum$pair, colnames(quant_matrix))
  quant_matrix[bio, valid_pairs] <- pair_sum$total[match(valid_pairs, pair_sum$pair)]
}


# Compute Bray–Curtis dissimilarity and convert to similarity
bray_dissim <- vegdist(quant_matrix, method = "bray")
bray_sim <- 1- as.matrix(bray_dissim)

# --- Step 9: Prepare Bray–Curtis data for plotting ---
bray_df <- as.data.frame(bray_sim) %>%
  mutate(Bioregion1 = rownames(.)) %>%
  pivot_longer(-Bioregion1, names_to = "Bioregion2", values_to = "BrayCurtis")

# --- Step 10: Plot Bray–Curtis similarity heatmap ---
ggplot(bray_df, aes(x = Bioregion1, y = Bioregion2, fill = BrayCurtis)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(BrayCurtis, 2)), color = "red", size = 4) +
  scale_fill_viridis_c(option = "viridis", name = "Bray–Curtis\nSimilarity", limits = c(0, 1)) +
  theme_minimal() +
  labs(title = "Bray–Curtis Similarity of Plant-Pollinator Metawebs (Quantitative)",
       x = "Bioregion", y = "Bioregion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))



```

