---
title: "similarity_between_patches_graphs"
output: html_document
date: "2025-09-30"
---


```{r}
setwd("/Users/shirn/OneDrive/Documents/master/data")

# ============================
# Libraries
# ============================
library(dplyr)
library(readr)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf) # for coord_sf CRS handling and sf objects
library(tidyr)
library(purrr)

# ============================
# Parameters (easy to tweak)
# ============================
bioregions <- c("Atlantic", "Boreal", "Continental", "Alpine", "Mediterranean", "Steppic", "Pannonian")
min_total <- 15     # Minimum total species per network (plants + pollinators)
top_n_pairs <- 50   # How many top-similar network pairs to keep

# ============================
# Read data
# Notes:
# 1) Don't over-specify col_types for columns that might not exist in all files.
# 2) Enforce key columns' types after reading.
# ============================
interactions <- read_csv("Interaction_data.csv", show_col_types = FALSE) %>%
  mutate(
    Network_id            = as.character(Network_id),
    Bioregion             = as.character(Bioregion),
    Plant_accepted_name   = as.character(Plant_accepted_name),
    Pollinator_accepted_name = as.character(Pollinator_accepted_name),
    Latitude              = suppressWarnings(as.double(Latitude)),
    Longitude             = suppressWarnings(as.double(Longitude)),
    Country               = as.character(Country)
  )

# ---------- Jaccard ----------
jaccard_sets <- function(a, b) {
  ia <- length(base::intersect(a, b))
  ua <- length(base::union(a, b))
  if (ua == 0) NA_real_ else ia / ua
}

# ---------- number of species per network ----------
species_per_network <- interactions %>%
  group_by(Bioregion, Network_id) %>%
  summarise(
    n_plants       = n_distinct(Plant_accepted_name),
    n_pollinators  = n_distinct(Pollinator_accepted_name),
    .groups = "drop"
  ) %>%
  mutate(total_species = n_plants + n_pollinators) %>%
  filter(total_species >= min_total)

# ---------- Build EDGE sets per network ----------
edge_key <- function(p, a) paste0("EDGE::PLANT::", p, " | POLL::", a)

# Loop over each bioregion
for (bio in bioregions) {
  cat(sprintf("Processing Bioregion for Pollinators: %s\n", bio))
  cat(sprintf("Filtering networks with total species >= %d\n", min_total))

  sub_data <- species_per_network %>% filter(Bioregion == bio)
  nets <- sub_data$Network_id

  if (length(nets) == 0) {
    cat(sprintf("No networks in %s with at least %d total species.\n", bio, min_total))
    next
  }

  dat_bio <- interactions %>%
    filter(Bioregion == bio, Network_id %in% nets) %>%
    filter(!is.na(Plant_accepted_name), !is.na(Pollinator_accepted_name)) %>%
    mutate(edge = edge_key(Plant_accepted_name, Pollinator_accepted_name))

  edges_tbl <- dat_bio %>%
    group_by(Network_id) %>%
    summarise(items = list(unique(edge)), .groups = "drop")

  # ---------- Compute pairwise similarity matrix ----------
  net_ids <- edges_tbl$Network_id
  n <- length(net_ids)
  sim_mat <- matrix(NA_real_, nrow = n, ncol = n, dimnames = list(net_ids, net_ids))

  for (i in seq_len(n)) {
    for (j in seq_len(n)) {
      if (i == j) {
        sim_mat[i, j] <- NA_real_
      } else {
        it_i <- edges_tbl$items[[i]]
        it_j <- edges_tbl$items[[j]]
        sim_mat[i, j] <- jaccard_sets(it_i, it_j)
      }
    }
  }

  # ---------- Flatten to unique pairs (upper triangle) and pick top-N ----------
  sim_df <- as.data.frame(as.table(sim_mat), stringsAsFactors = FALSE) %>%
    filter(!is.na(Freq), as.character(Var1) < as.character(Var2)) %>%
    arrange(desc(Freq)) %>%
    slice_head(n = top_n_pairs)

  if (nrow(sim_df) == 0) {
    cat(sprintf("No off-diagonal similarities found for %s (all NA).\n", bio))
    next
  }

  # Print sim_df with bioregion title
  cat(sprintf("\nTop similar network pairs by EDGE Jaccard for %s:\n", bio))
  cat(sprintf("=== %s ===\n", bio))
  print(head(sim_df, 20), row.names = FALSE)

  # ---------- Collect unique networks from top pairs ----------
  unique_nets <- unique(c(as.character(sim_df$Var1), as.character(sim_df$Var2)))
  cat(sprintf("Unique networks appearing in top pairs for %s:\n", bio),
      paste(unique_nets, collapse = ", "), "\n")

  # ---------- Summarize locations & sizes for those networks ----------
  first_unique <- function(x) {
    ux <- unique(x)
    ux[!is.na(ux)][1] %||% NA
  }

  top_network_locs <- interactions %>%
    filter(Bioregion == bio, Network_id %in% unique_nets) %>%
    group_by(Network_id) %>%
    summarise(
      Latitude       = first_unique(Latitude),
      Longitude      = first_unique(Longitude),
      Country        = first_unique(Country),
      n_plants       = n_distinct(Plant_accepted_name),
      n_pollinators  = n_distinct(Pollinator_accepted_name),
      .groups = "drop"
    ) %>%
    mutate(total_species = n_plants + n_pollinators)

  if (any(is.na(top_network_locs$Latitude)) || any(is.na(top_network_locs$Longitude))) {
    warning(sprintf("Some networks in %s lack coordinates; the map may omit them.", bio))
  }

  # ---------- Map ----------
  lat_range <- range(top_network_locs$Latitude, na.rm = TRUE)
  lon_range <- range(top_network_locs$Longitude, na.rm = TRUE)
  lat_buffer <- 1; lon_buffer <- 2
  xlim <- c(lon_range[1] - lon_buffer, lon_range[2] + lon_buffer)
  ylim <- c(lat_range[1] - lat_buffer, lat_range[2] + lat_buffer)

  europe <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf", continent = "Europe")

  cols <- grDevices::hcl.colors(length(unique_nets), "Spectral", rev = TRUE)

  p_map <- ggplot(europe) +
    geom_sf(fill = "grey90", color = "white") +
    geom_point(
      data = top_network_locs,
      aes(x = Longitude, y = Latitude, color = Network_id, size = total_species),
      alpha = 0.8
    ) +
    scale_color_manual(values = cols) +
    scale_size_continuous(range = c(2, 8), name = "Total Species") +
    coord_sf(
      xlim = xlim,
      ylim = ylim,
      expand = FALSE,
      default_crs = NULL
    ) +
    labs(
      title = sprintf("Most similar networks in %s (Jaccard on edges)", bio),
      subtitle = sprintf("Similarity computed on interaction sets; Lat range: %.2fâ€“%.2f",
                         lat_range[1], lat_range[2]),
      x = "Longitude", y = "Latitude", color = "Network_id"
    ) +
    theme_minimal() + theme(legend.position = "bottom")

  print(p_map)
}

```

